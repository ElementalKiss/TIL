# 05 TCP 기반 서버와 클라이언트2

## 05-1 에코 클라이언트. TCP 기반으로 완벽 구현

### 에코 클라이언트는 무엇이 문제인가?

* 문제는 서버에 있지 않고 클라이언트에 있음.
* TCP는 연결 지향 프로토콜로 전송되는 데이터의 경계가 없다.
* ABCD라는 문자열을 전송할지라도 그 데이터가 하나의 패킷으로 구성되어 전해진다는 보장이 없다.
* 기존에 만들었던 에코 클라이언트는 read, write를 한번씩만 호출.

```cpp
    for (recv_len = 0; recv_len < str_len; ) { /* data received.. */
        recv_num = read(...);
        ...
        recv += recv_num;
    }
```

* 계속해서 read 함수를 호출해서 수신한 데이터를 배열에 저장해나감. 이를 통해 정확히 전송한 바이트 크기만큼 데이터를 수신할 수 있다.
* 이러한 방법도 수신해야 할 데이터의 크기를 미리 알고 있는 경우만 가능.
* 기존 에코 클라이언트는 한번에 보내고 한번에 받는 형태로 구현.

### 에코 클라이언트의 해결책

* 에코 클라이언트의 경우 해결하기 쉬움. 클라이언트가 수신할 데이터의 크기를 미리 알 수 있음.

```cpp
while(recv_len < str_len) { }

// recv_len에 저장된 값과 str_len에 저장된 값을 비교해서 while문을 나가게 하면 됨.
// !=를 안 쓰는 것은 무한루프를 방지하기 위함.
```

### 에코 클라이언트 이외의 경우? 어플리케이션 프로토콜의 정의

* 송수신 과정에서 데이터의 끝을 파악할 수 있는 프로토콜을 별도로 정의.
* 서버, 클라이언트의 구현 과정에서 만들어지는 프로토콜을 어플리케이션 프로토콜이라 부름.

## 05-2 TCP의 이론적인 이야기

### TCP 소켓에 존재하는 입출력 버퍼

* read, write를 바이트 단위로 호출하기 위해 데이터가 저장되는 공간.
* 입출력 버퍼는 TCP 소켓 각각에 대해 별도로 존재.
* 입출력 버퍼는 소켓생성시 자동 생성.
* 소켓 닫았을 때, 출력 버퍼의 데이터는 계속해서 전송.
* 소켓 닫았을 때, 입력 버퍼의 데이터늰 소멸.
* 입력 버퍼의 크기를 초과하는 분량의 데이터 전송은 발생하지 않음.(가용한 양만큼 보냄)
* TCP는 '슬라이딩 윈도우(Sliding Window)'라는 프로토콜이 존재.

### TCP의 내부 동작원리1: 상대 소켓과의 연결

* TCP 소켓의 생성과 소멸 과정
    + 상대 소켓과 연결.
    + 상대 소켓과의 데이터 송수신.
    + 상대 소켓과의 연결 종료.

* 이를 Three-way handshaking이라 함.
* 전 이중(Full-dupliex) 방식으로 동작. 양방향으로 데이터 주고받을 수 있음.

* 예시
    + (AtoB) [SYN] SEQ: 1000, ACK: - (A가 SEQ 1000을 부여하고 전달.)
    + (BtoA) [SYN+ACK] SEQ: 2000, ACK:1001 (B가 SEQ 1000은 잘 받았으니 SEQ에 2000을 부여, 잘 받았으니 ACK에 1001을 담아 전달.)
    + (AtoB) [ACK] SEQ: 1001, ACK:2001 - (A가 SEQ 2000은 잘 받았으니 SEQ에 1001을 부여하고, 2001 보내라고 ACK에 담아 전달. )

### TCP의 내부 동작원리2: 상대 소켓과의 데이터 송수신

* ACK 번호 = SEQ + 전송 바이트 크기 + 1
* 패킷 전송에 실패 했다면, ACK waiting 후에 time out 후 해당 ACK 번호로 재전송.

### TCP 내부 동작원리3: 상대 소켓과의 연결 종료

* 네 번의 단계를 걸쳐서 진행되기 때문에 이를 Four-way handshaking이라 부름.
    + (AtoB) [FIN] SEQ: 5000, ACK: -
    + (BtoA) [ACK] SEQ: 7500, ACK: 5001
    + (BtoA) [FIN] SEQ: 7501, ACK: 5001
    + (AtoB) [ACK] SEQ: 5001, ACK: 7502