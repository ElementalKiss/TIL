# 12 IO 멀티플렉싱

## 12-1 IO 멀티플렉싱 기반의 서버

### 멀티프로세스 서버의 단점과 대안

* 프로세스 생성에는 적지 않은 비용 발생.
* 프로세스간 별도의 메모리 공간을 유지하기 때문에 프로세스간 데이터 통신이 다소 복잡한 편.

### 멀티플렉싱 단어의 이해

* 하나의 통신채널을 통해 둘 이상의 데이터(시그널)를 전송하는데 사용되는 기술.
* 물리적 장치의 효율성을 높이기 위해 최소한의 물리적 요소만 사용해 최대한의 데이터를 전달하기 위해 사용되는 기술.


### 종이컵 송수화기 예제

* 3자 대화일 때 대화 상대마다 각각 연결하는 것이 아닌 센터에 한 점을 두고 세 개의 종이컵으로 연결.
* 각각 연결할 때보다 컵의 갯수가 줄고 실의 길이가 짧아짐.
* 동시간에 말하지 않으므로 time 분할 멀티플렉싱 기술이 적용되었다 할 수 있음.
* 목소리 마다 주파수가 다르므로 frequenct 분할 멀티플렉싱 기술이 적용되었다 할 수 있음.

### 멀티플렉싱 개념 서버에 적용하기

* client를 맞을 child process를 만드는 것이 아니라 하나의 서버 프로세스가 멀티플렉싱으로 통신.
* 하나의 프로세스를 이용해 둘 이상의 클라이언트에게 서비스를 제공하는 방법을 알아야됨.

## 12-2  select 함수의 이해와 서버의 구현

### select 함수의 기능과 호출순서

* select 함수를 사용하면 한곳에 여러 개의 파일 디스크립터를 모아놓고 동시에 이들을 관찰 가능.
* 관찰 가능한 항목
    + 수신한 데이터를 지니고 있는 소켓 존재 유무
    + 블로킹되지 않고 데이터의 전송이 가능한 소켓 찾기
    + 예외상황이 발생한 소켓 찾기
* 관찰 항목을 가르켜 '이벤트(event)'라 함.
* select 함수는 멀티플렉싱 서버의 전부라 해도 과언이 아닐 정도로 중요하여 호출방법고 순서를 알야놔야 함.

### Select 함수의 호출 과정

* Step One
    + 파일 디스크립터의 설정
    + 검사의 범위 지정과 타임아웃의 설정
* Step Two
    + select 함수의 호출
* Step Three
    + 호출결과 확인

### Step1-1: 파일디스크립터의 설정

* 파일디스크립터는 관찰항목(수신, 전송, 예외)에 따라 구분.
* 파일 디스크립터들을 세 묶음으로 모을 때 사용되는 것이 fd_set형 변수. 비트단위 이진 배열이라고 보면 됨.
* fd[N]. N은 N번째 파일 디스크립터를 의미하고 그 안의 비트가 1인 디스크립터가 관찰대상.
* fd_set을 등록 및 변경하는 매크로
    + FD_ZERO(fd_set* fdset) - 모든 비트를 0으로 초기화.
    + FD_SET(int fd, fd_set* fdset) - fd로 전달된 파일 디스크립터의 정보 등록.
    * FD_CLR(int fd, fd_set* fdset) - fd로 전달된 파일 디스크립터의 정보 삭제.
    + FD_ISSET(int fd, fd_set* fdset) - fd 파일 디스크립터에 정보가 있으면 양수 반환.

### Step1-2: 검사(관찰)의 범위지정과 타임아웃의 설정

```cpp
#include <sys/select.h>
#include <sys/time.h>

int select(int maxfd, fd_set* readset, fd_set* writeset, fd_set* exceptset, const struct timeval* timeout);
// 성공 시 0 이상, 실패 시 -1

/*
maxfd: 검사대상이 되는 파일 디스크립터의 수
readset: '수신된 데이터의 존재여부'에 관심 있는 파일 디스크립터 정보를 모두 등록해서 변수 전달.
writeset: '블로킹 없는 데이터 전송의 가능여부' 위와 동일.
exceptset: '예외상황의 발생여부' 위와 동일.
timeout: 무한정 블로킹 상태에 빠지지 않도록 타임아웃을 설정하기 위해 인자 전달.
*/
```

### Setp2, Step3: select 함수호출 이후의 결과확인

||호출 전|||
|---|----|---|---|
|fd0|fd1|fd2|fd3|
|0|1|1|1|

* fd1과 fd3에 변화가 발생 했다 가정.

||호출 후|||
|---|----|---|---|
|fd0|fd1|fd2|fd3|
|0|**1**|0|**1**|


* 1로 설정된 값들이 모두 0으로 변경되지만, 변화가 발생한 파일 디스크립터에 해당하는 비트만 1로 남게 됨.(fd1, fd3)
* 여전히 1로 남아있는 위치의 파일 디스크립터에서 변화가 발생했다 판단할 수 있음.