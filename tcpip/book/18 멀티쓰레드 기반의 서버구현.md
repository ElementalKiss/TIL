# 18 멀티쓰레드 기반의 서버구현

## 18-1 쓰레드의 이론적 이해

### 쓰레드의 등장배경

* 멀티프로세스 기반의 단점
    * 프로세스 생성이라는 부담스러운 작업과정
    * 두 프로세스 사이에서의 데이터 교환을 위해서 별도의 IPC 기법을 적용해야 함
    * 크리티컬한 이유: 수십 ~ 수천 번까지 일어나는 컨텍스트 스위칭에 따른 부담

* 컨텍스트 스위칭이란?
    * 실행중인 둘 이상의 프로세스들은 CPU 할당시간을 매우 작은 크기로 쪼개서 서로 나누어서 사용한다.
    * CPU의 할당 시간을 나누기 위해서 '컨텍스트 스위칭' 과정을 거친다.
        * 실행중인 A 프로세스의 뒤를 이어 B 프로세스를 컨텍스트 스위칭한다고 가정.
        * A 관련 데이터를 메인 메모리에서 내리고 하드디스크로 이동시킨다.
        * 그 후 B 관련 데이터를 메인 메모리에 올린다. 이것이 컨텍스트 스위칭이다.
        * 하드디스크로 이동하는 비용이 크고 시간이 오래 걸린다.
* 이 컨텍스트 스위칭을 극복하기 위해 '쓰레드'라는 것이 등장
    * 단점을 아주 없애는 것이 아니라 최소화하기 위해서 고안.
    * 경량화 된 프로세스라고 보면 된다.
    * 쓰레드의 생성 및 컨텍스트 스위칭은 프로세스의 생성 및 컨텍스트 스위칭보다 빠름.
    * 쓰레드 사이에서의 데이터 교환에는 특별한 기법이 필요치 않음.

### 쓰레드와 프로세스의 차이점

* 프로세스의 메모리 구조
    * 전역변수가 할당되는 데이터 영역
    * 동적 할당이 이뤄지는 힙 영역
    * 함수 실행에 사용되는 스택 영역

* 쓰레드의 등장
    * 위의 프로세스 기준으로 둘 이상의 실행흐름을 갖는 것이 목적이라면 스택 영역만 분리시키면 된다.
    * 컨텍스트 스위칭 시 데이터 영역과 힙은 올리고 내릴 필요가 없다.
    * 데이터 영역과 힙을 이용해서 데이터를 교환할 수 있다.

* 쓰레드 메모리 구조.
    * 쓰레드의 공유 힙 영역
    * 쓰레드 공유 데이터 영역
    * N개 쓰레드의 N개 스택 영역

* 프로세스와 쓰레드의 정의
    * 프로세스: 운영체제 관점에서 별도의 실행흐름을 구성하는 단위
    * 쓰레드: 프로세스 관점에서 별도의 실행흐름을 구성하는 단위

## 18-2 쓰레드의 생성 및 실행

### 쓰레드의 생성과 실행흐름의 구성

* 쓰레드 생성
    * 쓰레드는 별도의 실행흐름을 갖기 때문에 쓰레드만의 main 함수를 별도로 정의해야 한다.
    * 그리고 이 함수를 시작으로 별도의 실행흐름을 형성해 줄 것을 운영체제에게 요청해야 한다.

```cpp
#include <ptherad.h>
int pthread_create(
    pthread_t* restrict thread, const pthread_attr_t* restrict attr,
    void* (*start_routine)(void* ), void* restrict arg
);

/*
therad: 생성할 쓰레드의 ID 저장을 위한 변수 주소 값 전달.
attr: 쓰레드에 부여할 특성 정보의 전달.
start_routine: 쓰레드 main 함수 역할을 하는 별도 실행흐름의 시작이 되는 함수 포인터.
arg: 세 번쨰 인자를 통해 등록된 함수가 호출될 때 전달할 인자의 정보를 담고 있는 변수.
*/
```

* 쓰레드 조인
    * thread_main 함수의 실행 시간을 정확히 예측할 수 없다.
    * 함수가 딱 필요한만큼만 대기하도록 하는 방법이 있다.

```cpp
#include <pthread.h>
int pthread_join(pthread_t thread, void** status);

/*
status: 쓰레드의 main 함수가 반환하는 값이 저장될 변수.
*/
```

### 임계영역 내에서 호출이 가능한 함수

* 임계영역: 둘 이상의 쓰레드가 동시에 동시에 실행할 수 있는 문제를 가지고 있는 영역
* 임계영역과 관련해서 함수는 두 가지로 구분
    * 쓰레드에 안전한 함수(임계영역이 없거나 있더라도 안전하게 구현된 함수)
    * 쓰레드에 안전하지 않은 함수
* 대부분의 표준함수는 쓰레드에 안전. 일부는 안전한 형태로 재구현된 함수들이 있다.
* 헤더파일 선언 매크로를 통한 방법도 있다. _REENTRANT를 정의하면 가능.
* 위의 매크로를 사용하지 않아도 컴파일 시 -D_REENTRANT 옵션을 추가하여 사용할 수 있다.